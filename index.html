<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>KR-EN Practice</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --bg:#f5f5f5;
  --text:#1b1f2a;
  --card:#ffffff;
  --shadow:rgba(0,0,0,0.12);
  --border:#d9dce3;
  --btn:#eceff5;
  --btn-text:#1b1f2a;
  --accent:#165ef0;
  --ok:#12a150;
  --bad:#d22f27;
  --diff-miss:#ffe2e2;
}
:root.dark{
  --bg:#0b1020;
  --text:#e6ecff;
  --card:#121933;
  --shadow:rgba(0,0,0,0.35);
  --border:#2a3357;
  --btn:#1a2450;
  --btn-text:#e6ecff;
  --accent:#6aa7ff;
  --ok:#22c55e;
  --bad:#ef4444;
  --diff-miss:rgba(239,68,68,.22);
}
@media (prefers-color-scheme: dark){
  :root:not(.light){
    --bg:#0b1020;
    --text:#e6ecff;
    --card:#121933;
    --shadow:rgba(0,0,0,0.35);
    --border:#2a3357;
    --btn:#1a2450;
    --btn-text:#e6ecff;
    --accent:#6aa7ff;
    --ok:#22c55e;
    --bad:#ef4444;
    --diff-miss:rgba(239,68,68,.22);
  }
}
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif; margin: 20px; background: var(--bg); color: var(--text);}
.card { background: var(--card); padding: 20px; border-radius: 12px; max-width: 880px; margin: auto; box-shadow: 0 8px 24px var(--shadow); border:1px solid var(--border); }
h1 { font-size: 22px; }
.toprow { display:flex; align-items:center; gap:12px; justify-content:space-between; flex-wrap:wrap; }
.row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 10px 0;}
select, input[type="file"] { background: var(--btn); color: var(--btn-text); border:1px solid var(--border); padding: 8px 10px; border-radius: 8px; }
button { margin: 5px 5px 5px 0; padding: 8px 14px; font-size: 15px; background: var(--btn); color: var(--btn-text); border:1px solid var(--border); border-radius: 8px; cursor: pointer;}
button:hover{filter:brightness(1.05)} button:disabled{opacity:.6; cursor:not-allowed}
.kbd { background: #dde3ef; color:#0f172a; padding: 2px 4px; border-radius: 4px; }
.toggle button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
#question { margin-top: 8px; margin-bottom: 12px; font-size: 18px; }
#answerBox {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  min-height: 90px;
  padding: 10px 12px;
  font-size: 16px;
  border: 1px solid var(--border);
  border-radius: 10px;
  resize: vertical;
  background: transparent;
  color: var(--text);
}
#feedback { margin-top: 10px; }
.correct { color: var(--ok); }
.incorrect { color: var(--bad); }
.small { font-size: 13px; color:#6b7aa6; }
hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
.pill { display:inline-block; background:#11204a22; color:var(--btn-text); border:1px solid var(--border); padding:4px 10px; border-radius: 999px; font-size:12px;}
</style>
</head>
<body>
<div class="card">
  <div class="toprow">
    <h1 style="margin:0;">KR-EN Practice</h1>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="themeBtn" title="Toggle Dark Mode" style="margin:0">ğŸŒ™ Dark</button>
    </div>
  </div>

  <div class="row">
    <label for="setSelect">ì„¸íŠ¸ ì„ íƒ:</label>
    <select id="setSelect"></select>
    <span id="progress" class="pill">0/0</span>
  </div>

  <div class="row">
    <div class="toggle">
      <button id="seqBtn" class="active">ìˆœì°¨ ì—°ìŠµ</button>
      <button id="randBtn">ëœë¤ ì—°ìŠµ</button>
    </div>
    <span class="small">ëª¨ë“œë¥¼ ë°”ê¾¸ë©´ í˜„ì¬ ì„¸íŠ¸ê°€ <b>ì²˜ìŒë¶€í„°</b> ìƒˆ ìˆœì„œë¡œ ì‹œì‘í•©ë‹ˆë‹¤.</span>
  </div>

  <div class="row" style="align-items:flex-start;">
    <div>
      <input type="file" id="jsonFile" accept=".json">
      <button id="loadJsonBtn">JSON ì„¸íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
    <div class="small">í˜•ì‹: 
<code>{ [ { "title": "ì„¸íŠ¸ ì œëª©", "body": [ {"english":"...", "korean":"..."}, ... ] } ] }</code><br>
(ë£¨íŠ¸ ë°°ì—´, ë˜ëŠ” <code>{"sets":[...]}</code> í˜•ì‹ë„ ì§€ì›)</div>
  </div>

  <hr/>

  <div id="question">ì—¬ê¸°ì— í•œêµ­ì–´ ë¬¸ì¥ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
  <textarea id="answerBox" placeholder="ì˜ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”"></textarea><br>
  <button id="checkBtn">Check</button>
  <button id="nextBtn" disabled>Next</button>
  <button id="showBtn">Show Answer</button>
  <div id="feedback"></div>

  <div style="margin-top:10px; font-size:14px;">
    ë‹¨ì¶•í‚¤: <span class="kbd">Enter</span> = Check, <span class="kbd">Ctrl</span>/<span class="kbd">âŒ˜</span>+<span class="kbd">Enter</span> = Next
  </div>

  <hr/>

  <div class="small">
    ì˜µì…˜:
    <label><input type="checkbox" id="ignoreContractions" checked> ì¶•ì•½í˜• ì°¨ì´ ë¬´ì‹œ</label>
    <label><input type="checkbox" id="ignorePunct" checked> ë¬¸ì¥ë¶€í˜¸ ë¬´ì‹œ</label>
    <label><input type="checkbox" id="ignoreCase" checked> ëŒ€ì†Œë¬¸ì ë¬´ì‹œ</label>
    <label><input type="checkbox" id="ignoreSpaces" checked> ê³µë°± ë‹¨ìˆœí™”</label>
  </div>
</div>

<script>
// ---------- Built-in sets (removed) ----------
const builtinSets = [ /* removed */ 
  {
    key: "A",
    title: "ì„¸íŠ¸ A (Minnesota & Family)",
    items: [
      ["ì €ëŠ” ì œ ìì‹ ì— ëŒ€í•´ ì¡°ê¸ˆ ë§ì”€ë“œë¦¬ê³ ì í•©ë‹ˆë‹¤.","Let me tell you a little about myself."],
      ["ì €ëŠ” ë¯¸ë„¤ì†Œíƒ€ì—ì„œ íƒœì–´ë‚˜ê³  ìëìœ¼ë©°, ì„¸ì¸íŠ¸í´ ì‹œ ì¶œì‹ ì…ë‹ˆë‹¤.","I was born and raised in Minnesota and Iâ€™m a native of the city of Saint Paul."],
      ["ì €ëŠ” ë¶€ëª¨ë‹˜ê³¼ ì—¬ëŸ í˜•ì œ, ë‘ ìë§¤ì™€ í•¨ê»˜ ê·¸ê³³ì—ì„œ ìëìŠµë‹ˆë‹¤.","I grew up there with my parents and my eight brothers and two sisters."],
      ["ì €ëŠ” ì—´í•œ ë²ˆì§¸ ì•„ì´ì´ë¯€ë¡œ, ê°€ì¡±ì˜ ë§‰ë‚´ë¼ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì €ëŠ” ì‘ì„ë°›ì´ëŠ” ì•„ë‹ˆì—ˆë‹¤ê³  ë§¹ì„¸í•©ë‹ˆë‹¤.","Iâ€™m the eleventh child, so you could say Iâ€™m the baby of the family, but I swear I wasnâ€™t spoiled."],
      ["ë§ìŠµë‹ˆë‹¤, ì €ëŠ” ëŒ€ê°€ì¡±ì˜ ì¼ì›ì´ì—ìš”. ì•„ë§ˆë„ ë™ë„¤ì—ì„œ ê°€ì¥ í° ê°€ì¡±ì¼ ê±°ê³ , ì–´ì©Œë©´ ì£¼ì—ì„œ ê°€ì¥ í° ê°€ì¡±ì¼ì§€ë„ ëª°ë¼ìš”!","Thatâ€™s right, Iâ€™m part of a big family, probably the biggest family in the neighborhood, perhaps the biggest family in the state!"]
    ]
  },
  {
    key: "B",
    title: "ì„¸íŠ¸ B (Mornings & Alarms)",
    items: [
      ["ì œ í•˜ë£¨ì—ì„œ ê°€ì¥ í˜ë“  ìˆœê°„ì€ ë¶„ëª…íˆ ì¼ì–´ë‚˜ì•¼ í•  ë•Œì…ë‹ˆë‹¤.","The worst part of the day for me is definitely when I have to get up."],
      ["ì ì—ì„œ ê¹¨ëŠ” ê±´ ê´œì°®ìŠµë‹ˆë‹¤. ê·¸ê±´ ê°ë‹¹í•  ìˆ˜ ìˆì–´ìš”.","Waking up, that I can handle."],
      ["í•˜ì§€ë§Œ ì¼ì–´ë‚˜ëŠ” ê±´ìš”? ê·¸ê±´ ì •ë§ ì‹«ìŠµë‹ˆë‹¤.","But getting up? That, I hate."],
      ["ì œê°€ ì‚¬ìš©í•˜ëŠ” ì´ë¶ˆì€ ë¬´ê²ìŠµë‹ˆë‹¤. ì£¼ë¡œ ì´ë¶ˆê³¼ ì–‡ì€ ë‹´ìš”ë¥¼ í•¨ê»˜ ë®ê¸° ë•Œë¬¸ì´ì£ .","The covers I have on my bed are heavy, mostly because I have a comforter as well as a light blanket."],
      ["ì €ëŠ” ë² ê°œ ë‘ ê°œë¥¼ ë² ê³  ìëŠ”ë°, ì´ìœ ëŠ” ëª¨ë¥´ê² ì§€ë§Œ ë² ê°œ ì»¤ë²„ ìƒ‰ê¹”ì´ ì„œë¡œ ë‹¤ë¦…ë‹ˆë‹¤.","I sleep with two pillows, which for some reason have different color pillowcases."],
      ["ë­, ì ì–´ë„ ì‹œíŠ¸ëŠ” ìƒ‰ì´ ë§ìŠµë‹ˆë‹¤.","Well, at least the sheets match."]
    ]
  }
];

// Imported sets container
let importedSets = []; // array of {key, title, items} (load via JSON)

// ---------- Theme handling ----------
(function(){
  const root = document.documentElement;
  const saved = localStorage.getItem('theme');
  if(saved === 'dark'){ root.classList.add('dark'); root.classList.remove('light'); }
  else if(saved === 'light'){ root.classList.add('light'); root.classList.remove('dark'); }
  const btn = document.getElementById('themeBtn');
  function updateBtn(){
    const isDark = root.classList.contains('dark') || (!root.classList.contains('light') && window.matchMedia('(prefers-color-scheme: dark)').matches);
    btn.textContent = isDark ? 'â˜€ï¸ Light' : 'ğŸŒ™ Dark';
    btn.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
  }
  btn.addEventListener('click', ()=>{
    const isDark = root.classList.contains('dark');
    if(isDark){
      root.classList.remove('dark'); root.classList.add('light'); localStorage.setItem('theme','light');
    } else {
      root.classList.add('dark'); root.classList.remove('light'); localStorage.setItem('theme','dark');
    }
    updateBtn();
  });
  updateBtn();
})();

// ---------- App State ----------
let mode = 'seq'; // 'seq' | 'rand'
let order = [];
let idx = 0; // position
let currentItems = []; // [ [ko,en], ... ]

const els = {
  setSelect: document.getElementById('setSelect'),
  progress: document.getElementById('progress'),
  question: document.getElementById('question'),
  answerBox: document.getElementById('answerBox'),
  checkBtn: document.getElementById('checkBtn'),
  nextBtn: document.getElementById('nextBtn'),
  showBtn: document.getElementById('showBtn'),
  feedback: document.getElementById('feedback'),
  seqBtn: document.getElementById('seqBtn'),
  randBtn: document.getElementById('randBtn'),
  jsonFile: document.getElementById('jsonFile'),
  loadJsonBtn: document.getElementById('loadJsonBtn'),
  ignoreContractions: document.getElementById('ignoreContractions'),
  ignorePunct: document.getElementById('ignorePunct'),
  ignoreCase: document.getElementById('ignoreCase'),
  ignoreSpaces: document.getElementById('ignoreSpaces')
};

function shuffle(arr){
  let a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function rebuildSetSelect(){
  els.setSelect.innerHTML = "";

  const og2 = document.createElement('optgroup');
  og2.label = "ê°€ì ¸ì˜¨ ì„¸íŠ¸";
  if(importedSets.length === 0){
    const opt = document.createElement('option');
    opt.disabled = true;
    opt.textContent = "(JSONì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”)";
    og2.appendChild(opt);
  } else {
    importedSets.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = "imported:" + s.key;
      opt.textContent = s.title;
      og2.appendChild(opt);
    });
  }
  els.setSelect.appendChild(og2);

  els.setSelect.selectedIndex = 0;
}

function pickSetByValue(value){
  if(value.startsWith("builtin:")){
    const key = value.split(":")[1];
    const found = builtinSets.find(s=>s.key===key);
    return found ? found.items : [];
  } else if(value.startsWith("imported:")){
    const key = value.split(":")[1];
    const found = importedSets.find(s=>s.key===key);
    return found ? found.items : [];
  }
  return [];
}

function buildOrder(){
  order = Array.from({length: currentItems.length}, (_,i)=>i);
  if(mode==='rand') order = shuffle(order);
  idx = 0;
}

function updateProgress(){
  const total = currentItems.length;
  els.progress.textContent = total ? `${Math.min(idx+1,total)}/${total}` : `0/0`;
}

function loadItem(){
  if(currentItems.length === 0){
    els.question.textContent = "ì„¸íŠ¸ì— ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.";
    els.answerBox.value = "";
    els.answerBox.disabled = true;
    els.checkBtn.disabled = true;
    els.nextBtn.disabled = true;
    updateProgress();
    return;
  }
  const [ko,] = currentItems[order[idx]];
  els.question.textContent = ko;
  els.answerBox.value = "";
  els.answerBox.disabled = false;
  els.checkBtn.disabled = false;
  els.nextBtn.disabled = true;
  els.feedback.innerHTML = "";
  updateProgress();
  els.answerBox.focus();
}

function onSetChange(){
  const value = els.setSelect.value || "";
  if(!value.startsWith("imported:")){
    // no sets yet
    currentItems = [];
    buildOrder();
    loadItem();
    return;
  }
  currentItems = pickSetByValue(value);
  buildOrder();
  loadItem();
}

function normalize(str){
  let s = str;
  if(els.ignoreContractions.checked){
    // normalize common contractions both directions by simplifying punctuation/case later
    s = s.replace(/\b(can not)\b/gi,"can't")
         .replace(/\b(are not)\b/gi,"aren't")
         .replace(/\b(will not)\b/gi,"won't")
         .replace(/\b(I am)\b/gi,"I'm")
         .replace(/\b(you are)\b/gi,"you're")
         .replace(/\b(we are)\b/gi,"we're")
         .replace(/\b(they are)\b/gi,"they're")
         .replace(/\b(it is)\b/gi,"it's");
    s = s.replace(/[â€™â€˜]/g,"'");
  }
  if(els.ignorePunct.checked){ s = s.replace(/[.,!?;:(){}\[\]â€”â€“\-]/g," "); }
  if(els.ignoreCase.checked){ s = s.toLowerCase(); }
  if(els.ignoreSpaces.checked){ s = s.replace(/\s+/g," ").trim(); }
  return s;
}

function check(){
  const [,en] = currentItems[order[idx]];
  const user = els.answerBox.value.trim();
  if(!user){
    els.feedback.innerHTML = `<div class="incorrect">ì…ë ¥ì´ ë¹„ì–´ ìˆì–´ìš”.</div>`;
    return;
  }
  const ok = normalize(user) === normalize(en);
  if(ok){
    els.feedback.innerHTML = `<div class="correct">âœ” Correct!</div>`;
  }else{
    els.feedback.innerHTML = `<div class="incorrect">âœ˜ Incorrect.<br>Your: ${user}<br>Answer: ${en}</div>`;
  }
  els.nextBtn.disabled = false;
}

function next(){
  if(idx < currentItems.length-1){
    idx++;
    loadItem();
  } else {
    els.feedback.innerHTML = `<div class="correct">ì™„ë£Œ! ìˆ˜ê³ í•˜ì…¨ì–´ìš” ğŸ‰</div>`;
    idx = 0;
    buildOrder();
    loadItem();
  }
}

function showAnswer(){
  const [,en] = currentItems[order[idx]];
  els.feedback.innerHTML = `<div>Answer: ${en}</div>`;
  els.nextBtn.disabled = false;
}

// JSON loader
function coerceSets(schema){
  // Accept formats:
  // 1) { sets: [ {title, body:[{english,korean},...]}, ... ] }
  // 2) [ {title, body:[...]}, ... ]
  // 3) { <anyKey>: [ {title, body:[...]} ] } -> use first array value
  let arr = null;
  if(Array.isArray(schema)){
    arr = schema;
  } else if (schema && typeof schema === 'object'){
    if(Array.isArray(schema.sets)) arr = schema.sets;
    else {
      // find first array value
      for(const k of Object.keys(schema)){
        if(Array.isArray(schema[k])){ arr = schema[k]; break; }
      }
    }
  }
  if(!Array.isArray(arr)) throw new Error("ìœ íš¨í•œ ì„¸íŠ¸ ë°°ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  const out = [];
  arr.forEach((s, i)=>{
    const title = s.title || `Imported Set ${i+1}`;
    const body = Array.isArray(s.body) ? s.body : [];
    const items = body.map((it, j)=>{
      const en = it.english ?? it.English ?? it.EN ?? "";
      const ko = it.korean ?? it.Korean ?? it.KO ?? "";
      if(!en || !ko) throw new Error(`ë¬¸ì¥ ${j+1}ì— english/korean ëˆ„ë½`);
      return [ko, en];
    });
    out.push({ title, items });
  });
  return out;
}

function loadJsonFile(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onerror = ()=> reject(new Error("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
    reader.onload = ()=>{
      try{
        const text = reader.result;
        const data = JSON.parse(text);
        const sets = coerceSets(data);
        resolve(sets);
      }catch(e){
        reject(e);
      }
    };
    reader.readAsText(file, "utf-8");
  });
}

els.loadJsonBtn.addEventListener('click', async ()=>{
  const file = els.jsonFile.files && els.jsonFile.files[0];
  if(!file){ alert("JSON íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
  try{
    const imported = await loadJsonFile(file);
    // Add to importedSets with unique keys
    imported.forEach((s, i)=>{
      const key = `J${Date.now()}_${i}`;
      importedSets.push({ key, title: s.title, items: s.items });
    });
    rebuildSetSelect();
    // auto-select first imported set
    const lastGroupIndex = els.setSelect.options.length - 1;
    els.setSelect.selectedIndex = els.setSelect.options.length - 1; // last option overall
    onSetChange();
  }catch(err){
    alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message);
  }
});

// Event wiring
els.seqBtn.onclick = ()=>{ mode='seq'; els.seqBtn.classList.add('active'); els.randBtn.classList.remove('active'); buildOrder(); loadItem(); };
els.randBtn.onclick = ()=>{ mode='rand'; els.randBtn.classList.add('active'); els.seqBtn.classList.remove('active'); buildOrder(); loadItem(); };
els.setSelect.onchange = onSetChange;
els.checkBtn.onclick = check;
els.nextBtn.onclick = next;
els.showBtn.onclick = showAnswer;

els.answerBox.addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && (e.ctrlKey||e.metaKey)){
    e.preventDefault();
    if(!els.nextBtn.disabled){ next(); } else { check(); }
    return;
  }
  if(e.key==="Enter" && !e.shiftKey && !e.ctrlKey && !e.metaKey){
    e.preventDefault();
    check();
  }
});

// Init
rebuildSetSelect();
// Wait for JSON import before loading set
currentItems = []; buildOrder(); loadItem();
</script>
</body>
</html>
